
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>dziewicza2.gpx</title>
    <style>
        body { font-family: sans-serif; }
        canvas { }
        #itineraryTable th {
            position: sticky;
            top: 0;
            background-color: #f2f2f2; /* Add a background to prevent content from showing through */
            z-index: 1; /* Ensure it stays on top of scrolling content */
        }
        .current-position-row {
            font-weight: bold;
            color: red;
        }
        #itineraryTable th:nth-child(4),
        #itineraryTable td:nth-child(4),
        #itineraryTable th:nth-child(5),
        #itineraryTable td:nth-child(5) {
            display: none;
        }
        #itineraryTable {
        }
        #itineraryTable th {
            font-size: 2em;
        }
        #itineraryTable td {
            font-size: 3em;
        }
    </style>
</head>
<body>
    <button id="refreshButton" style="position: absolute; top: 10px; right: 10px; z-index: 10; font-size: 4em; padding: 20px; border-radius: 10px;">Refresh GPS</button>
    <div id="gpsStatus" style="position: absolute; top: 150px; right: 10px; z-index: 10; font-size: 2em;"></div>
    <canvas id="profileCanvas" style="width: 100%; height: 33vh;"></canvas>
    <script>
        window.addEventListener('load', function() {
            const canvas = document.getElementById('profileCanvas');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            const elevations = [106.0, 105.0, 104.0, 104.0, 106.0, 106.0, 105.0, 105.0, 105.0, 103.0, 103.0, 103.0, 102.0, 102.0, 107.0, 115.0, 123.0, 132.0, 134.0, 136.0, 138.0, 141.0, 141.0, 141.0, 140.0, 138.0, 138.0, 141.0, 143.0, 143.0, 141.0, 138.0, 138.0, 136.0, 134.0, 131.0, 129.0, 128.0, 126.0, 120.0, 118.0, 115.0, 111.0, 109.0, 108.0, 107.0, 106.0, 106.0, 106.0, 106.0, 107.0, 107.0, 107.0, 106.0, 106.0, 108.0, 111.0, 114.0, 118.0, 119.0, 121.0, 122.0, 123.0, 125.0, 127.0, 128.0, 128.0, 128.0, 130.0, 130.0, 130.0, 132.0, 133.0, 133.0, 135.0, 136.0, 136.0, 136.0, 139.0, 141.0, 141.0, 140.0, 140.0, 141.0, 143.0, 145.0, 144.0, 141.0, 138.0, 136.0, 134.0, 133.0, 132.0, 128.0, 125.0, 122.0, 117.0, 116.0, 115.0, 114.0, 114.0, 113.0, 109.0, 104.0, 98.0, 98.0, 97.0, 96.0, 96.0, 95.0, 95.0, 95.0, 96.0, 96.0, 100.0, 110.0, 111.0, 112.0, 113.0, 115.0, 117.0, 118.0, 121.0, 121.0, 121.0, 122.0, 123.0, 123.0, 125.0, 127.0, 129.0, 132.0, 133.0, 136.0, 137.0, 138.0, 138.0, 139.0, 141.0, 141.0, 141.0, 142.0, 145.0, 144.0, 141.0, 138.0, 138.0, 140.0, 141.0, 141.0, 141.0, 138.0, 136.0, 134.0, 132.0, 123.0, 115.0, 107.0, 102.0, 100.0, 99.0, 98.0, 98.0, 97.0, 97.0, 97.0, 98.0, 98.0, 99.0, 101.0, 103.0, 105.0, 107.0, 111.0, 112.0, 112.0, 114.0, 117.0, 122.0, 125.0, 128.0, 132.0, 133.0, 134.0, 136.0, 138.0, 141.0, 144.0, 145.0, 142.0, 141.0, 142.0, 143.0, 142.0, 139.0, 133.0, 131.0, 128.0, 125.0, 123.0, 122.0, 123.0, 119.0, 121.0, 125.0, 121.0, 113.0, 113.0, 113.0, 113.0, 113.0, 113.0, 115.0, 116.0, 112.0, 106.0, 106.0, 106.0, 106.0];
            const distances = [0, 0.014352877253927856, 0.03906387533204593, 0.0749445871089576, 0.12120569178721918, 0.14417792779841127, 0.16591364629701622, 0.175121787928138, 0.18335176359855485, 0.2189976617299953, 0.2232668024257927, 0.2232668024257927, 0.25894640407241426, 0.3039316454617492, 0.3412787795640276, 0.37104508760011523, 0.403471312253874, 0.44555537635416476, 0.47480620187894185, 0.496623150959376, 0.545004948295521, 0.5656186119476058, 0.5894474434651011, 0.6101390296088752, 0.6308213684438823, 0.6504882287253912, 0.6629213118944965, 0.6897355844662253, 0.7223106767583841, 0.7223106767583841, 0.7548857690505429, 0.7817000416222717, 0.8058011451702933, 0.8214109226514854, 0.8358367816161334, 0.849207509807433, 0.8660019931347972, 0.8806906645498878, 0.894939377206647, 0.9254865415971685, 0.9393827588813535, 0.9562343509422004, 0.987906346736254, 1.0063833266662996, 1.026688496813249, 1.0615652410435266, 1.0881140624451076, 1.1008844600410677, 1.1422489727526997, 1.1507378218188515, 1.1645806673569659, 1.1645806673569659, 1.1659702554475642, 1.1891985478501081, 1.2022292110765298, 1.248487911675939, 1.2717425157183895, 1.2869524381361794, 1.3072215167986834, 1.3194732371147915, 1.3305203386701063, 1.3403562030200469, 1.3498625772895918, 1.3689497630718428, 1.3848546500717944, 1.3999352898701152, 1.412124789015988, 1.4211702151385817, 1.4331827225732967, 1.4402819878117983, 1.452471527687409, 1.4633717248046816, 1.4664224763901028, 1.4664224763901028, 1.4803830813099694, 1.4891599896578784, 1.4946085410631371, 1.5010557107306386, 1.5187357040667306, 1.5354854330891154, 1.5505689900099322, 1.5622749078356022, 1.5723416870106781, 1.5817502499141387, 1.6006268313863155, 1.6174851024643202, 1.6354587577157387, 1.683070003099665, 1.7098842756713937, 1.7275505300884975, 1.7433495018824454, 1.753815856941993, 1.7629973343538847, 1.7877882421528908, 1.8103942905833075, 1.836348135605021, 1.8787904363322578, 1.901258345007175, 1.9175896803323988, 1.9408957579578094, 1.9560060177086034, 1.976699359786285, 2.009241276555167, 2.054019682518319, 2.125402520598246, 2.125402520598246, 2.134217052682359, 2.1564146146792376, 2.2102419327770235, 2.241645080014633, 2.2665781257105837, 2.3419064401190277, 2.3717321531997633, 2.416162866892231, 2.4708859031422596, 2.556997668333065, 2.589851101224985, 2.6084608861658527, 2.6285946966188223, 2.655791489005553, 2.6764301827464894, 2.68799445511756, 2.713264914133727, 2.7157112025200516, 2.7157112025200516, 2.7248543033512447, 2.7407495102399553, 2.764258288177715, 2.787023367933351, 2.8119950957011595, 2.8309618720061676, 2.846239019548716, 2.8619518687696743, 2.8981805957417226, 2.911359790233123, 2.9270475467432684, 2.9352973627229155, 2.9490000141354504, 2.973571139525314, 2.9888654991250814, 3.0013418011705735, 3.0118246369956037, 3.0373462031682976, 3.055319858419716, 3.1029311038036425, 3.129745376375371, 3.142178459544476, 3.1618453198259853, 3.1825276586609923, 3.2032192448047665, 3.2270480763222618, 3.2476617399743466, 3.2960435373104917, 3.317860486390926, 3.347111311915703, 3.389195376015994, 3.4216216006697526, 3.4513879087058403, 3.4887350428081185, 3.5361384743995323, 3.581587558277452, 3.600183660824458, 3.600183660824458, 3.619411327142109, 3.64993723585656, 3.6793643887628797, 3.6974940724024736, 3.7197777546270823, 3.7413526462470936, 3.760601102654817, 3.7780271822099167, 3.7975910253809797, 3.8157253296084765, 3.839173317562892, 3.8614321161862972, 3.8614321161862972, 3.897700854015512, 3.9366735683796112, 3.979115869106848, 4.005069714128561, 4.027675762558978, 4.052466670357984, 4.061648147769876, 4.072114502829423, 4.087913474623371, 4.105579729040475, 4.132394001612203, 4.18000524699613, 4.197978902247548, 4.223500468420242, 4.233983304245272, 4.258388561371539, 4.284808458151519, 4.304667813910452, 4.324834016389619, 4.361428465274046, 4.384310527484395, 4.404250118589365, 4.4254015480287165, 4.446499383746355, 4.465952161808383, 4.489152867638473, 4.527660067920448, 4.547764769097529, 4.652660002054113, 4.740982424423042, 4.795012211116584, 4.801776603621825, 4.801776603621825, 4.820908494073801, 4.826852445543538, 4.859275343490727, 4.943787744320032, 5.006131893491395, 5.08288107789022, 5.163911887350029, 5.196896580306772, 5.342168411465151, 5.348862066070544];
            const lats = [52.481372, 52.481273, 52.481054, 52.480737, 52.480321, 52.480118, 52.479943, 52.479867, 52.479801, 52.479506, 52.479468, 52.479468, 52.479155, 52.478751, 52.478822, 52.478926, 52.479041, 52.479172, 52.479249, 52.479325, 52.479484, 52.479544, 52.479566, 52.479577, 52.479654, 52.479681, 52.479659, 52.479845, 52.480004, 52.480004, 52.479845, 52.479659, 52.479807, 52.479856, 52.479917, 52.479993, 52.480026, 52.480014, 52.480059, 52.480217, 52.480277, 52.480343, 52.480518, 52.480639, 52.480737, 52.480901, 52.481027, 52.481131, 52.481503, 52.481569, 52.481628, 52.481628, 52.481634, 52.481618, 52.48164, 52.481524, 52.481453, 52.481443, 52.481377, 52.481361, 52.481377, 52.481421, 52.481481, 52.481569, 52.481612, 52.481645, 52.481645, 52.481618, 52.481519, 52.481498, 52.481498, 52.481437, 52.48141, 52.48141, 52.481289, 52.481213, 52.481164, 52.48112, 52.480961, 52.480814, 52.48071, 52.480617, 52.480535, 52.480452, 52.480288, 52.48014, 52.480075, 52.479845, 52.479659, 52.479517, 52.479375, 52.479281, 52.479205, 52.479025, 52.478844, 52.47863, 52.478291, 52.478089, 52.477946, 52.477739, 52.477607, 52.477421, 52.477137, 52.476748, 52.476135, 52.476135, 52.476059, 52.475862, 52.475747, 52.475703, 52.475709, 52.475632, 52.475643, 52.475709, 52.476201, 52.476967, 52.477262, 52.477427, 52.477591, 52.477794, 52.477963, 52.478067, 52.478291, 52.478313, 52.478313, 52.478395, 52.478537, 52.478734, 52.478899, 52.479106, 52.479271, 52.479408, 52.479544, 52.479785, 52.479884, 52.480014, 52.480064, 52.480108, 52.48014, 52.480195, 52.480272, 52.480239, 52.48014, 52.480075, 52.479845, 52.479659, 52.479681, 52.479654, 52.479577, 52.479566, 52.479544, 52.479484, 52.479325, 52.479249, 52.479172, 52.479041, 52.478926, 52.478822, 52.478751, 52.478335, 52.477946, 52.477788, 52.477788, 52.477624, 52.477389, 52.477219, 52.477164, 52.477066, 52.477214, 52.477366, 52.477492, 52.477596, 52.477722, 52.477854, 52.477941, 52.477941, 52.478078, 52.478291, 52.47863, 52.478844, 52.479025, 52.479205, 52.479281, 52.479375, 52.479517, 52.479659, 52.479845, 52.480075, 52.48014, 52.480239, 52.480272, 52.480343, 52.480436, 52.480491, 52.480556, 52.480688, 52.480764, 52.480847, 52.48101, 52.481169, 52.481333, 52.481541, 52.481881, 52.482061, 52.482986, 52.483751, 52.4842, 52.484254, 52.484254, 52.484408, 52.484386, 52.484271, 52.483888, 52.483664, 52.483308, 52.483002, 52.482887, 52.482367, 52.482307];
            const lons = [17.005485, 17.005621, 17.005683, 17.005782, 17.005791, 17.005728, 17.005585, 17.005531, 17.005476, 17.00527, 17.005261, 17.005261, 17.005145, 17.00518, 17.005719, 17.006124, 17.006564, 17.007147, 17.00756, 17.007857, 17.008522, 17.00881, 17.00916, 17.009465, 17.009743, 17.01003, 17.01021, 17.010462, 17.010866, 17.010866, 17.010462, 17.01021, 17.00995, 17.009734, 17.009546, 17.009393, 17.009151, 17.008935, 17.008738, 17.008369, 17.008189, 17.007965, 17.007596, 17.007409, 17.007156, 17.006717, 17.006384, 17.006464, 17.006464, 17.006527, 17.006707, 17.006707, 17.006725, 17.007067, 17.007256, 17.007912, 17.008235, 17.008459, 17.008738, 17.008917, 17.009078, 17.009204, 17.009304, 17.009546, 17.00977, 17.009986, 17.010166, 17.010292, 17.010363, 17.010462, 17.010642, 17.010768, 17.010776, 17.010776, 17.010831, 17.010866, 17.010866, 17.010804, 17.010804, 17.010858, 17.011001, 17.011082, 17.011145, 17.011172, 17.011244, 17.011298, 17.011055, 17.010462, 17.01021, 17.010093, 17.010085, 17.010093, 17.01004, 17.009824, 17.009672, 17.009519, 17.009231, 17.009223, 17.009168, 17.009114, 17.009061, 17.009051, 17.008935, 17.008764, 17.008451, 17.008451, 17.008414, 17.008361, 17.009133, 17.009591, 17.009959, 17.011064, 17.011504, 17.012151, 17.01217, 17.012357, 17.012384, 17.01243, 17.012556, 17.01278, 17.012906, 17.012906, 17.012843, 17.012843, 17.012843, 17.012833, 17.01286, 17.012986, 17.013185, 17.013328, 17.013399, 17.013382, 17.013319, 17.012959, 17.012852, 17.012762, 17.012672, 17.012483, 17.012124, 17.011917, 17.011783, 17.011638, 17.011298, 17.011055, 17.010462, 17.01021, 17.01003, 17.009743, 17.009465, 17.00916, 17.00881, 17.008522, 17.007857, 17.00756, 17.007147, 17.006564, 17.006124, 17.005719, 17.00518, 17.005333, 17.005539, 17.005629, 17.005629, 17.005719, 17.005952, 17.006285, 17.006537, 17.006824, 17.00703, 17.007166, 17.007319, 17.007552, 17.007722, 17.007992, 17.008288, 17.008288, 17.008774, 17.009231, 17.009519, 17.009672, 17.009824, 17.01004, 17.010093, 17.010085, 17.010093, 17.01021, 17.010462, 17.011055, 17.011298, 17.011638, 17.011783, 17.012124, 17.012483, 17.012762, 17.01304, 17.013535, 17.013849, 17.01411, 17.014271, 17.014441, 17.014541, 17.014514, 17.014406, 17.014378, 17.014074, 17.013723, 17.013418, 17.013372, 17.013372, 17.013246, 17.013166, 17.012726, 17.011648, 17.010804, 17.009833, 17.008747, 17.008298, 17.00633, 17.006338];
            const importantPointsData = [{"name": "firepit", "lat": 52.4812582, "lon": 17.0052396, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "toilets", "lat": 52.4816371, "lon": 17.005672, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "picnic_table", "lat": 52.4817061, "lon": 17.0058636, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "picnic_table", "lat": 52.4812922, "lon": 17.0049353, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "recycling", "lat": 52.4812834, "lon": 17.0053564, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "shelter", "lat": 52.4811884, "lon": 17.0050889, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "shelter", "lat": 52.48125607692308, "lon": 17.00522301153846, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "shelter", "lat": 52.481310900000004, "lon": 17.0052916, "trail_distance": 0, "trail_elevation": 106.0}, {"name": "map", "lat": 52.4812591, "lon": 17.0056387, "trail_distance": 0.014352877253927856, "trail_elevation": 105.0}, {"name": "picnic_table", "lat": 52.4816642, "lon": 17.0058968, "trail_distance": 1.1422489727526997, "trail_elevation": 106.0}, {"name": "picnic_table", "lat": 52.4816768, "lon": 17.0059648, "trail_distance": 1.1422489727526997, "trail_elevation": 106.0}, {"name": "playground", "lat": 52.481428699999995, "lon": 17.0060342, "trail_distance": 1.1422489727526997, "trail_elevation": 106.0}, {"name": "nature Szczyt Dziewiczej G\u00f3ry", "lat": 52.4801623, "lon": 17.0111737, "trail_distance": 1.6174851024643202, "trail_elevation": 145.0}, {"name": "tower Wie\u017ca widokowa na Dziewiczej G\u00f3rze", "lat": 52.48003285, "lon": 17.01133309, "trail_distance": 1.6174851024643202, "trail_elevation": 145.0}, {"name": "peak Dziewicza G\u00f3ra", "lat": 52.479996, "lon": 17.0111017, "trail_distance": 1.6354587577157387, "trail_elevation": 144.0}, {"name": "shelter", "lat": 52.4800919, "lon": 17.0109379, "trail_distance": 1.6354587577157387, "trail_elevation": 144.0}, {"name": "board G\u00f3ra Anny", "lat": 52.4801481, "lon": 17.011057, "trail_distance": 1.6354587577157387, "trail_elevation": 144.0}, {"name": "guidepost", "lat": 52.4801496, "lon": 17.0110113, "trail_distance": 1.6354587577157387, "trail_elevation": 144.0}, {"name": "wayside_cross", "lat": 52.480534, "lon": 17.0150263, "trail_distance": 4.404250118589365, "trail_elevation": 128.0}, {"name": "peak", "lat": 52.4844672, "lon": 17.0033025, "trail_distance": 5.342168411465151, "trail_elevation": 106.0}, {"name": "map", "lat": 52.4819636, "lon": 17.0061648, "trail_distance": 5.348862066070544, "trail_elevation": 106.0}, {"name": "Exit: wielkopolska-droga-sw-jakuba", "lat": 52.479659, "lon": 17.01021, "trail_distance": 0.6629213118944965, "trail_elevation": 138.0}, {"name": "Entry: wielkopolska-droga-sw-jakuba", "lat": 52.482367, "lon": 17.00633, "trail_distance": 5.342168411465151, "trail_elevation": 106.0}, {"name": "Entry: czerwony-szlak-jezioro-plotki-czerwonak", "lat": 52.48014, "lon": 17.012124, "trail_distance": 2.973571139525314, "trail_elevation": 141.0}, {"name": "Entry: niebieski-szlak-slawa-wielkopolska-dziewicza-gora", "lat": 52.480075, "lon": 17.011055, "trail_distance": 1.6354587577157387, "trail_elevation": 144.0}, {"name": "Entry: wielkopolska-droga-sw-jakuba", "lat": 52.479659, "lon": 17.01021, "trail_distance": 0.6629213118944965, "trail_elevation": 138.0}, {"name": "Entry: wielkopolska-droga-sw-jakuba", "lat": 52.477164, "lon": 17.006537, "trail_distance": 3.6974940724024736, "trail_elevation": 98.0}, {"name": "Entry: czerwony-szlak-jezioro-plotki-czerwonak", "lat": 52.478751, "lon": 17.00518, "trail_distance": 0.3039316454617492, "trail_elevation": 102.0}, {"name": "Exit: czerwony-szlak-jezioro-plotki-czerwonak", "lat": 52.482061, "lon": 17.014378, "trail_distance": 4.547764769097529, "trail_elevation": 121.0}, {"name": "Exit: czerwony-szlak-jezioro-plotki-czerwonak", "lat": 52.478751, "lon": 17.00518, "trail_distance": 0.3039316454617492, "trail_elevation": 102.0}, {"name": "Exit: zolty-szlak-kobylnica-dziewicza-gora", "lat": 52.480764, "lon": 17.013849, "trail_distance": 4.384310527484395, "trail_elevation": 131.0}, {"name": "Exit: niebieski-szlak-slawa-wielkopolska-dziewicza-gora", "lat": 52.482061, "lon": 17.014378, "trail_distance": 4.547764769097529, "trail_elevation": 121.0}, {"name": "Entry: zolty-szlak-kobylnica-dziewicza-gora", "lat": 52.480075, "lon": 17.011055, "trail_distance": 1.6354587577157387, "trail_elevation": 144.0}, {"name": "Exit: wielkopolska-droga-sw-jakuba", "lat": 52.481131, "lon": 17.006464, "trail_distance": 1.1008844600410677, "trail_elevation": 106.0}, {"name": "Exit: czerwony-szlak-jezioro-plotki-czerwonak", "lat": 52.479856, "lon": 17.009734, "trail_distance": 0.8214109226514854, "trail_elevation": 136.0}, {"name": "Entry: czerwony-szlak-jezioro-plotki-czerwonak", "lat": 52.479517, "lon": 17.010093, "trail_distance": 1.7275505300884975, "trail_elevation": 136.0}, {"name": "Exit: wielkopolska-droga-sw-jakuba", "lat": 52.478089, "lon": 17.009223, "trail_distance": 1.901258345007175, "trail_elevation": 116.0}];
            const minLat = 52.475632;
            const maxLat = 52.484408;
            const minLon = 17.005145;
            const maxLon = 17.014541;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const paddingTop = 60;
            const paddingRight = 0;
            const paddingBottom = 40;
            const paddingLeft = 80;

            const maxEle = Math.max(...elevations);
            const minEle = Math.min(...elevations);
            const eleRange = maxEle - minEle;
            const maxDist = distances[distances.length - 1];

            let lastRefreshTime;
            let gpsStatusMessage = '';

            function getX(distance) {
                return paddingLeft + (distance / maxDist) * (width - paddingLeft - paddingRight);
            }

            function getY(elevation) {
                return height - paddingBottom - ((elevation - minEle) / eleRange) * (height - paddingTop - paddingBottom);
            }

            function drawProfile() {
                ctx.clearRect(0, 0, width, height);
                ctx.strokeStyle = 'black';
                ctx.fillStyle = 'black';
                // Draw profile
                ctx.beginPath();
                ctx.moveTo(getX(distances[0]), getY(elevations[0]));
                for (let i = 1; i < elevations.length; i++) {
                    ctx.lineTo(getX(distances[i]), getY(elevations[i]));
                }
                ctx.stroke();

                // Draw axes
                ctx.beginPath();
                ctx.moveTo(paddingLeft, paddingTop);
                ctx.lineTo(paddingLeft, height - paddingBottom);
                ctx.lineTo(width - paddingRight, height - paddingBottom);
                ctx.stroke();

                // Draw labels
                ctx.font = '35px Arial'; // Set a much bigger font
                ctx.textAlign = 'left';
                ctx.fillText(maxEle.toFixed(0) + ' m', 5, paddingTop + 5);
                ctx.fillText(minEle.toFixed(0) + ' m', 5, height - paddingBottom);

                // Draw y-axis label
                ctx.save();
                ctx.translate(60, height / 2); // Translate to the position where the text will be drawn
                ctx.rotate(-Math.PI / 2); // Rotate -90 degrees (counter-clockwise)
                ctx.textAlign = 'center'; // Center the text horizontally after rotation
                ctx.fillText('Elevation', 0, 0); // Draw text at the new origin
                ctx.restore(); // Restore the canvas to its original state

                ctx.textAlign = 'center';
                ctx.fillText('Distance', width / 2, height - paddingBottom + 30);
                ctx.textAlign = 'left';
                ctx.fillText('0 km', paddingLeft, height - paddingBottom + 30);
                ctx.textAlign = 'right';
                ctx.textAlign = 'right';
                ctx.fillText(maxDist.toFixed(1) + ' km', width - paddingRight, height - paddingBottom + 30);
            }

            drawProfile();

            function haversine(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of Earth in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;  // deg2rad below
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    0.5 - Math.cos(dLat)/2 + 
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    (1 - Math.cos(dLon))/2;

                return R * 2 * Math.asin(Math.sqrt(a));
            }

            function calculateBearing(startLat, startLng, destLat, destLng) {
              // Convert degrees to radians
              const toRadians = (degrees) => degrees * Math.PI / 180;
              const toDegrees = (radians) => radians * 180 / Math.PI;

              const startLatRad = toRadians(startLat);
              const startLngRad = toRadians(startLng);
              const destLatRad = toRadians(destLat);
              const destLngRad = toRadians(destLng);

              // Calculate the difference in longitude
              const deltaLng = destLngRad - startLngRad;

              // Calculate the bearing
              const y = Math.sin(deltaLng) * Math.cos(destLatRad);
              const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                        Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(deltaLng);
              let bearing = Math.atan2(y, x);

              // Convert the bearing from radians to degrees
              bearing = toDegrees(bearing);

              // Ensure the bearing is a positive number between 0 and 360
              return (bearing + 360) % 360;
            }

            function getBearingArrow(bearing) {
                if (bearing >= 337.5 || bearing < 22.5) {
                    return '↑'; // North
                } else if (bearing >= 22.5 && bearing < 67.5) {
                    return '↗'; // North-East
                } else if (bearing >= 67.5 && bearing < 112.5) {
                    return '→'; // East
                } else if (bearing >= 112.5 && bearing < 157.5) {
                    return '↘'; // South-East
                } else if (bearing >= 157.5 && bearing < 202.5) {
                    return '↓'; // South
                } else if (bearing >= 202.5 && bearing < 247.5) {
                    return '↙'; // South-West
                } else if (bearing >= 247.5 && bearing < 292.5) {
                    return '←'; // West
                } else if (bearing >= 292.5 && bearing < 337.5) {
                    return '↖'; // North-West
                }
                return ''; // Should not happen
            }

            function sortTable() {
                const tableBody = document.querySelector('#itineraryTable tbody');
                const rows = Array.from(tableBody.children);

                rows.sort((a, b) => {
                    const distanceA = parseFloat(a.cells[0].textContent.trim());
                    const distanceB = parseFloat(b.cells[0].textContent.trim());

                    if (isNaN(distanceA) && isNaN(distanceB)) return 0; // Both NaN, keep original order
                    if (isNaN(distanceA)) return 1; // A is NaN, B is a number, put A at the end
                    if (isNaN(distanceB)) return -1; // B is NaN, A is a number, put B at the end

                    return distanceA - distanceB;
                });

                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }
                rows.forEach(row => tableBody.appendChild(row));
            }

            function updateStaticTable() {
                const maxEleIndex = elevations.indexOf(maxEle);
                const maxEleDistance = distances[maxEleIndex];

                document.getElementById('startDistance').innerText = distances[0].toFixed(1);
                document.getElementById('startHeight').innerText = elevations[0].toFixed(0);

                document.getElementById('highestPointDistance').innerText = maxEleDistance.toFixed(1);
                document.getElementById('highestPointHeight').innerText = maxEle.toFixed(0);

                document.getElementById('finishDistance').innerText = maxDist.toFixed(1);
                document.getElementById('finishHeight').innerText = elevations[elevations.length - 1].toFixed(0);

                document.getElementById('startLat').innerText = lats[0].toFixed(5);
                document.getElementById('startLon').innerText = lons[0].toFixed(5);
                document.getElementById('startLink').href = `geo:${lats[0]},${lons[0]}`;

                document.getElementById('highestPointLat').innerText = lats[maxEleIndex].toFixed(5);
                document.getElementById('highestPointLon').innerText = lons[maxEleIndex].toFixed(5);
                document.getElementById('highestPointLink').href = `geo:${lats[maxEleIndex]},${lons[maxEleIndex]}`;

                document.getElementById('finishLat').innerText = lats[lats.length - 1].toFixed(5);
                document.getElementById('finishLon').innerText = lons[lons.length - 1].toFixed(5);
                document.getElementById('finishLink').href = `geo:${lats[lats.length - 1]},${lons[lats.length - 1]}`;
                sortTable();
            }

            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) {
                    return Math.floor(interval) + " years ago";
                }
                interval = seconds / 2592000;
                if (interval > 1) {
                    return Math.floor(interval) + " months ago";
                }
                interval = seconds / 86400;
                if (interval > 1) {
                    return Math.floor(interval) + " days ago";
                }
                interval = seconds / 3600;
                if (interval > 1) {
                    return Math.floor(interval) + " hours ago";
                }
                interval = seconds / 60;
                if (interval > 1) {
                    return Math.floor(interval) + " minutes ago";
                }
                return Math.floor(seconds) + " seconds ago";
            }

            function refreshLocation() {
                let dots = 0;
                const interval = setInterval(() => {
                    dots = (dots + 1) % 4;
                    gpsStatusMessage = ".".repeat(dots);
                }, 500);

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        clearInterval(interval);
                        lastRefreshTime = new Date();
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        gpsStatusMessage = `Lat: ${userLat.toFixed(5)}, Lon: ${userLon.toFixed(5)}`;
        
                        console.log('User Location:', userLat, userLon);
        
                        let nearestIndex = 0;
                        let minDistance = Infinity;
                        for (let i = 0; i < lats.length; i++) {
                            const dist = haversine(userLat, userLon, lats[i], lons[i]);
                            if (dist < minDistance) {
                                minDistance = dist;
                                nearestIndex = i;
                            }
                        }
                        console.log('Nearest Index:', nearestIndex, 'Min Distance:', minDistance);
                        updateMapAndTable(nearestIndex, userLat, userLon);
                    }, error => {
                        clearInterval(interval);
                        gpsStatusMessage = 'NOPE';
                        console.error('Error getting user location:', error);
                    });
                } else {
                    clearInterval(interval);
                    gpsStatusMessage = 'NOPE';
                    console.error('Geolocation is not supported by this browser.');
                }
            }

            updateStaticTable();
            refreshLocation();
            setInterval(refreshLocation, 30000);

            document.getElementById('refreshButton').addEventListener('click', refreshLocation);

            setInterval(() => {
                if (lastRefreshTime) {
                    document.getElementById('gpsStatus').innerText = `${gpsStatusMessage} (${formatTimeAgo(lastRefreshTime)})`
                } else {
                    document.getElementById('gpsStatus').innerText = gpsStatusMessage;
                }
            }, 1000);

            function updateMapAndTable(nearestIndex, actualLat, actualLon) {
                drawProfile();
                document.getElementById('currentPositionRow').style.display = '';
                console.log('Nearest Index:', nearestIndex);

                // Draw current position line
                const currentX = getX(distances[nearestIndex]);
                ctx.beginPath();
                ctx.strokeStyle = 'red';
                ctx.moveTo(currentX, paddingTop);
                ctx.lineTo(currentX, height - paddingBottom);
                ctx.stroke();

                // Draw info on top of the line
                const currentDist = distances[nearestIndex];
                const percentage = (currentDist / maxDist) * 100;
                const ele = elevations[nearestIndex];
                ctx.fillStyle = 'red';
                ctx.font = '35px Arial'; // Set a much bigger font for current position info

                let textX = currentX;
                if (currentX < paddingLeft + 50) {
                    ctx.textAlign = 'left';
                    textX = paddingLeft;
                } else if (currentX > width - paddingRight - 50) {
                    ctx.textAlign = 'right';
                    textX = width - paddingRight;
                } else {
                    ctx.textAlign = 'center';
                }

                ctx.fillText(ele.toFixed(0) + ' m', textX, paddingTop - 30);
                ctx.fillText(currentDist.toFixed(1) + ' km (' + percentage.toFixed(0) + '%)', textX, paddingTop - 5);

                ctx.strokeStyle = 'black';
                ctx.fillStyle = 'black';

                const tableBody = document.querySelector('#itineraryTable tbody');

                document.getElementById('currentDistance').innerText = currentDist.toFixed(1);
                document.getElementById('currentHeight').innerText = ele.toFixed(0);
                document.getElementById('currentLat').innerText = lats[nearestIndex].toFixed(5);
                document.getElementById('currentLon').innerText = lons[nearestIndex].toFixed(5);
                document.getElementById('currentLink').href = `geo:${actualLat},${actualLon}`;

                const maxEleIndex = elevations.indexOf(maxEle);

                const currentLat = actualLat;
                const currentLon = actualLon;

                const startBearing = calculateBearing(currentLat, currentLon, lats[0], lons[0]);
                const highestPointBearing = calculateBearing(currentLat, currentLon, lats[maxEleIndex], lons[maxEleIndex]);
                const finishBearing = calculateBearing(currentLat, currentLon, lats[lats.length - 1], lons[lats.length - 1]);

                document.getElementById('startDistFromCurrent').innerText = haversine(currentLat, currentLon, lats[0], lons[0]).toFixed(2) + ' km ' + getBearingArrow(startBearing);
                document.getElementById('currentDistFromCurrent').innerText = '';
                document.getElementById('highestPointDistFromCurrent').innerText = haversine(currentLat, currentLon, lats[maxEleIndex], lons[maxEleIndex]).toFixed(2) + ' km ' + getBearingArrow(highestPointBearing);
                document.getElementById('finishDistFromCurrent').innerText = haversine(currentLat, currentLon, lats[lats.length - 1], lons[lats.length - 1]).toFixed(2) + ' km ' + getBearingArrow(finishBearing);

                importantPointsData.forEach((point, index) => {
                    const dist = haversine(currentLat, currentLon, point.lat, point.lon);
                    const bearing = calculateBearing(currentLat, currentLon, point.lat, point.lon);
                    document.getElementById(`importantPointDistFromCurrent_${index}`).innerText = dist.toFixed(2) + ' km ' + getBearingArrow(bearing);
                });

                sortTable();

                // Scroll to current position
                const tableContainer = document.getElementById('tableContainer');
                const currentPositionRow = document.getElementById('currentDistance').closest('tr'); // Find the parent <tr>

                if (tableContainer && currentPositionRow) {
                    currentPositionRow.scrollIntoView({ block: "center" });
                    currentPositionRow.classList.add('current-position-row');
                }
            }
            // Calculate remaining height for tableContainer
            const canvasHeight = document.getElementById('profileCanvas').offsetHeight;

            const totalOccupiedHeight = canvasHeight;
            const windowHeight = window.innerHeight;
            const remainingHeight = windowHeight - totalOccupiedHeight - 25;

            if (tableContainer) {
                tableContainer.style.height = `${remainingHeight}px`;
            }
    });
    </script>
    <div id="tableContainer" style="height: 200px; overflow-y: scroll;">
        <table border="1" width="100%" id="itineraryTable">
            <thead>
                <tr>
                    <th>Distance (km)</th>
                    <th>Height (m)</th>
                    <th>Point</th>
                    <th>Lat</th>
                    <th>Lon</th>
                    <th>From Current (km)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="startDistance"></td>
                    <td id="startHeight"></td>
                    <td><a id="startLink" href="">START</a></td>
                    <td id="startLat"></td>
                    <td id="startLon"></td>
                    <td id="startDistFromCurrent"></td>
                </tr>
                <tr id="currentPositionRow" style="display: none;">
                    <td id="currentDistance"></td>
                    <td id="currentHeight"></td>
                    <td><a id="currentLink" href="">Current Position</a></td>
                    <td id="currentLat"></td>
                    <td id="currentLon"></td>
                    <td id="currentDistFromCurrent"></td>
                </tr>
                <tr>
                    <td id="highestPointDistance"></td>
                    <td id="highestPointHeight"></td>
                    <td><a id="highestPointLink" href="">Highest Point</a></td>
                    <td id="highestPointLat"></td>
                    <td id="highestPointLon"></td>
                    <td id="highestPointDistFromCurrent"></td>
                </tr>
                <tr>
                    <td id="finishDistance"></td>
                    <td id="finishHeight"></td>
                    <td><a id="finishLink" href="">FINISH</a></td>
                    <td id="finishLat"></td>
                    <td id="finishLon"></td>
                    <td id="finishDistFromCurrent"></td>
                </tr>
                
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.4812582,17.0052396">firepit</a></td>
                    <td>52.4812582</td>
                    <td>17.0052396</td>
                    <td id="importantPointDistFromCurrent_0"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.4816371,17.005672">toilets</a></td>
                    <td>52.4816371</td>
                    <td>17.005672</td>
                    <td id="importantPointDistFromCurrent_1"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.4817061,17.0058636">picnic_table</a></td>
                    <td>52.4817061</td>
                    <td>17.0058636</td>
                    <td id="importantPointDistFromCurrent_2"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.4812922,17.0049353">picnic_table</a></td>
                    <td>52.4812922</td>
                    <td>17.0049353</td>
                    <td id="importantPointDistFromCurrent_3"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.4812834,17.0053564">recycling</a></td>
                    <td>52.4812834</td>
                    <td>17.0053564</td>
                    <td id="importantPointDistFromCurrent_4"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.4811884,17.0050889">shelter</a></td>
                    <td>52.4811884</td>
                    <td>17.0050889</td>
                    <td id="importantPointDistFromCurrent_5"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.48125607692308,17.00522301153846">shelter</a></td>
                    <td>52.48125607692308</td>
                    <td>17.00522301153846</td>
                    <td id="importantPointDistFromCurrent_6"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>106</td>
                    <td><a href="geo:52.481310900000004,17.0052916">shelter</a></td>
                    <td>52.481310900000004</td>
                    <td>17.0052916</td>
                    <td id="importantPointDistFromCurrent_7"></td>
                </tr>
                <tr>
                    <td>0.0</td>
                    <td>105</td>
                    <td><a href="geo:52.4812591,17.0056387">map</a></td>
                    <td>52.4812591</td>
                    <td>17.0056387</td>
                    <td id="importantPointDistFromCurrent_8"></td>
                </tr>
                <tr>
                    <td>1.1</td>
                    <td>106</td>
                    <td><a href="geo:52.4816642,17.0058968">picnic_table</a></td>
                    <td>52.4816642</td>
                    <td>17.0058968</td>
                    <td id="importantPointDistFromCurrent_9"></td>
                </tr>
                <tr>
                    <td>1.1</td>
                    <td>106</td>
                    <td><a href="geo:52.4816768,17.0059648">picnic_table</a></td>
                    <td>52.4816768</td>
                    <td>17.0059648</td>
                    <td id="importantPointDistFromCurrent_10"></td>
                </tr>
                <tr>
                    <td>1.1</td>
                    <td>106</td>
                    <td><a href="geo:52.481428699999995,17.0060342">playground</a></td>
                    <td>52.481428699999995</td>
                    <td>17.0060342</td>
                    <td id="importantPointDistFromCurrent_11"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>145</td>
                    <td><a href="geo:52.4801623,17.0111737">nature Szczyt Dziewiczej Góry</a></td>
                    <td>52.4801623</td>
                    <td>17.0111737</td>
                    <td id="importantPointDistFromCurrent_12"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>145</td>
                    <td><a href="geo:52.48003285,17.01133309">tower Wieża widokowa na Dziewiczej Górze</a></td>
                    <td>52.48003285</td>
                    <td>17.01133309</td>
                    <td id="importantPointDistFromCurrent_13"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>144</td>
                    <td><a href="geo:52.479996,17.0111017">peak Dziewicza Góra</a></td>
                    <td>52.479996</td>
                    <td>17.0111017</td>
                    <td id="importantPointDistFromCurrent_14"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>144</td>
                    <td><a href="geo:52.4800919,17.0109379">shelter</a></td>
                    <td>52.4800919</td>
                    <td>17.0109379</td>
                    <td id="importantPointDistFromCurrent_15"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>144</td>
                    <td><a href="geo:52.4801481,17.011057">board Góra Anny</a></td>
                    <td>52.4801481</td>
                    <td>17.011057</td>
                    <td id="importantPointDistFromCurrent_16"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>144</td>
                    <td><a href="geo:52.4801496,17.0110113">guidepost</a></td>
                    <td>52.4801496</td>
                    <td>17.0110113</td>
                    <td id="importantPointDistFromCurrent_17"></td>
                </tr>
                <tr>
                    <td>4.4</td>
                    <td>128</td>
                    <td><a href="geo:52.480534,17.0150263">wayside_cross</a></td>
                    <td>52.480534</td>
                    <td>17.0150263</td>
                    <td id="importantPointDistFromCurrent_18"></td>
                </tr>
                <tr>
                    <td>5.3</td>
                    <td>106</td>
                    <td><a href="geo:52.4844672,17.0033025">peak</a></td>
                    <td>52.4844672</td>
                    <td>17.0033025</td>
                    <td id="importantPointDistFromCurrent_19"></td>
                </tr>
                <tr>
                    <td>5.3</td>
                    <td>106</td>
                    <td><a href="geo:52.4819636,17.0061648">map</a></td>
                    <td>52.4819636</td>
                    <td>17.0061648</td>
                    <td id="importantPointDistFromCurrent_20"></td>
                </tr>
                <tr>
                    <td>0.7</td>
                    <td>138</td>
                    <td><a href="geo:52.479659,17.01021">Exit: wielkopolska-droga-sw-jakuba</a></td>
                    <td>52.479659</td>
                    <td>17.01021</td>
                    <td id="importantPointDistFromCurrent_21"></td>
                </tr>
                <tr>
                    <td>5.3</td>
                    <td>106</td>
                    <td><a href="geo:52.482367,17.00633">Entry: wielkopolska-droga-sw-jakuba</a></td>
                    <td>52.482367</td>
                    <td>17.00633</td>
                    <td id="importantPointDistFromCurrent_22"></td>
                </tr>
                <tr>
                    <td>3.0</td>
                    <td>141</td>
                    <td><a href="geo:52.48014,17.012124">Entry: czerwony-szlak-jezioro-plotki-czerwonak</a></td>
                    <td>52.48014</td>
                    <td>17.012124</td>
                    <td id="importantPointDistFromCurrent_23"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>144</td>
                    <td><a href="geo:52.480075,17.011055">Entry: niebieski-szlak-slawa-wielkopolska-dziewicza-gora</a></td>
                    <td>52.480075</td>
                    <td>17.011055</td>
                    <td id="importantPointDistFromCurrent_24"></td>
                </tr>
                <tr>
                    <td>0.7</td>
                    <td>138</td>
                    <td><a href="geo:52.479659,17.01021">Entry: wielkopolska-droga-sw-jakuba</a></td>
                    <td>52.479659</td>
                    <td>17.01021</td>
                    <td id="importantPointDistFromCurrent_25"></td>
                </tr>
                <tr>
                    <td>3.7</td>
                    <td>98</td>
                    <td><a href="geo:52.477164,17.006537">Entry: wielkopolska-droga-sw-jakuba</a></td>
                    <td>52.477164</td>
                    <td>17.006537</td>
                    <td id="importantPointDistFromCurrent_26"></td>
                </tr>
                <tr>
                    <td>0.3</td>
                    <td>102</td>
                    <td><a href="geo:52.478751,17.00518">Entry: czerwony-szlak-jezioro-plotki-czerwonak</a></td>
                    <td>52.478751</td>
                    <td>17.00518</td>
                    <td id="importantPointDistFromCurrent_27"></td>
                </tr>
                <tr>
                    <td>4.5</td>
                    <td>121</td>
                    <td><a href="geo:52.482061,17.014378">Exit: czerwony-szlak-jezioro-plotki-czerwonak</a></td>
                    <td>52.482061</td>
                    <td>17.014378</td>
                    <td id="importantPointDistFromCurrent_28"></td>
                </tr>
                <tr>
                    <td>0.3</td>
                    <td>102</td>
                    <td><a href="geo:52.478751,17.00518">Exit: czerwony-szlak-jezioro-plotki-czerwonak</a></td>
                    <td>52.478751</td>
                    <td>17.00518</td>
                    <td id="importantPointDistFromCurrent_29"></td>
                </tr>
                <tr>
                    <td>4.4</td>
                    <td>131</td>
                    <td><a href="geo:52.480764,17.013849">Exit: zolty-szlak-kobylnica-dziewicza-gora</a></td>
                    <td>52.480764</td>
                    <td>17.013849</td>
                    <td id="importantPointDistFromCurrent_30"></td>
                </tr>
                <tr>
                    <td>4.5</td>
                    <td>121</td>
                    <td><a href="geo:52.482061,17.014378">Exit: niebieski-szlak-slawa-wielkopolska-dziewicza-gora</a></td>
                    <td>52.482061</td>
                    <td>17.014378</td>
                    <td id="importantPointDistFromCurrent_31"></td>
                </tr>
                <tr>
                    <td>1.6</td>
                    <td>144</td>
                    <td><a href="geo:52.480075,17.011055">Entry: zolty-szlak-kobylnica-dziewicza-gora</a></td>
                    <td>52.480075</td>
                    <td>17.011055</td>
                    <td id="importantPointDistFromCurrent_32"></td>
                </tr>
                <tr>
                    <td>1.1</td>
                    <td>106</td>
                    <td><a href="geo:52.481131,17.006464">Exit: wielkopolska-droga-sw-jakuba</a></td>
                    <td>52.481131</td>
                    <td>17.006464</td>
                    <td id="importantPointDistFromCurrent_33"></td>
                </tr>
                <tr>
                    <td>0.8</td>
                    <td>136</td>
                    <td><a href="geo:52.479856,17.009734">Exit: czerwony-szlak-jezioro-plotki-czerwonak</a></td>
                    <td>52.479856</td>
                    <td>17.009734</td>
                    <td id="importantPointDistFromCurrent_34"></td>
                </tr>
                <tr>
                    <td>1.7</td>
                    <td>136</td>
                    <td><a href="geo:52.479517,17.010093">Entry: czerwony-szlak-jezioro-plotki-czerwonak</a></td>
                    <td>52.479517</td>
                    <td>17.010093</td>
                    <td id="importantPointDistFromCurrent_35"></td>
                </tr>
                <tr>
                    <td>1.9</td>
                    <td>116</td>
                    <td><a href="geo:52.478089,17.009223">Exit: wielkopolska-droga-sw-jakuba</a></td>
                    <td>52.478089</td>
                    <td>17.009223</td>
                    <td id="importantPointDistFromCurrent_36"></td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>

